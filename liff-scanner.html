<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap');
  :root {
    --green:#00c853; --green-dark:#009624; --bg:#0d1117;
    --surface:#161b22; --surface2:#21262d; --border:#30363d;
    --text:#e6edf3; --muted:#7d8590; --red:#f85149;
    --yellow:#d29922; --blue:#388bfd;
  }
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{font-family:'Sarabun',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

  /* OVERLAYS */
  .ov{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:40px;text-align:center;z-index:9999}
  .ov.hidden{display:none}
  .ov-icon{width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px}
  .ov-icon.load{background:rgba(56,139,253,.1);border:2px solid var(--blue);animation:pulse 1.5s ease-in-out infinite}
  .ov-icon.block{background:rgba(248,81,73,.15);border:2px solid var(--red)}
  .ov-icon.ok{background:rgba(0,200,83,.15);border:2px solid var(--green)}
  .ov-title{font-size:20px;font-weight:700}
  .ov-title.red{color:var(--red)} .ov-title.green{color:var(--green)} .ov-title.blue{color:var(--blue)}
  .info-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 24px;width:100%;max-width:320px;text-align:left}
  .info-card .lbl{font-size:11px;color:var(--muted);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
  .info-card .val{font-size:15px;font-weight:600}
  .alert{border-radius:10px;padding:14px 16px;font-size:13px;line-height:1.7;width:100%;max-width:320px;white-space:pre-line;text-align:left}
  .alert.red{background:rgba(248,81,73,.1);border:1px solid rgba(248,81,73,.3);color:var(--red)}
  .alert.green{background:rgba(0,200,83,.1);border:1px solid rgba(0,200,83,.3);color:var(--green)}
  .alert.muted{background:var(--surface);border:1px solid var(--border);color:var(--muted);text-align:center}
  .success-id{font-family:'IBM Plex Mono',monospace;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 24px;font-size:15px;font-weight:600;letter-spacing:1px;word-break:break-all;max-width:320px;width:100%;text-align:center}

  /* HEADER */
  .hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100}
  .hdr-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--green),var(--green-dark));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
  .hdr-title{font-size:16px;font-weight:700}
  .hdr-sub{font-size:11px;color:var(--muted);margin-top:1px}
  .badge{margin-left:auto;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 10px;font-size:11px;color:var(--muted);font-family:'IBM Plex Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px}
  .badge.main{border-color:rgba(0,200,83,.5);color:var(--green)}

  /* CONTENT */
  .content{padding:20px 16px 40px;max-width:500px;margin:0 auto}

  /* STEPS */
  .steps{display:flex;margin-bottom:24px;background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .step{flex:1;padding:10px 4px;text-align:center;font-size:11px;color:var(--muted);transition:all .3s;border-right:1px solid var(--border)}
  .step:last-child{border-right:none}
  .step.active{background:rgba(0,200,83,.1);color:var(--green);font-weight:600}
  .step.done{color:var(--green)}
  .step-num{display:block;font-size:16px;font-weight:700;margin-bottom:2px;font-family:'IBM Plex Mono',monospace}

  /* BUTTONS */
  .btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;border:none;border-radius:10px;font-family:'Sarabun',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:all .2s;-webkit-appearance:none}
  .btn:active{transform:scale(.97)}
  .btn-primary{background:var(--green);color:#000}
  .btn-primary:hover{background:#00e676}
  .btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
  .btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
  .btn-row{display:flex;gap:8px}
  .btn-row .btn-back{flex:0 0 auto;width:auto;padding:14px 20px}

  /* CARD */
  .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px;animation:fadeIn .4s ease}
  .card-hdr{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-weight:600;font-size:14px}
  .card-body{padding:16px;display:flex;flex-direction:column;gap:14px}

  /* OCR ZONE */
  .ocr-zone{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:32px 20px;border:2px dashed var(--border);border-radius:14px;cursor:pointer;transition:all .2s;background:var(--surface2);margin-bottom:4px}
  .ocr-zone:active{background:rgba(56,139,253,.08);border-color:var(--blue)}
  .ocr-zone.scanning{border-color:var(--blue);background:rgba(56,139,253,.06);animation:borderPulse 1.2s ease-in-out infinite}
  .ocr-zone.done{border-color:var(--green);background:rgba(0,200,83,.06);animation:none}
  .ocr-zone-icon{font-size:52px;line-height:1}
  .ocr-zone-title{font-size:16px;font-weight:700;text-align:center}
  .ocr-zone-sub{font-size:12px;color:var(--muted);text-align:center;line-height:1.6}
  @keyframes borderPulse{0%,100%{border-color:var(--blue);box-shadow:0 0 0 0 rgba(56,139,253,.3)}50%{border-color:#6cb6ff;box-shadow:0 0 0 6px rgba(56,139,253,.0)}}

  /* OCR PREVIEW */
  .preview-wrap{display:none;position:relative;border-radius:12px;overflow:hidden;margin-bottom:8px;aspect-ratio:4/3;background:#000}
  .preview-wrap.show{display:block}
  .preview-wrap img{width:100%;height:100%;object-fit:cover}
  .preview-badge{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.7);color:#fff;font-size:11px;padding:4px 8px;border-radius:20px;backdrop-filter:blur(4px)}

  /* SPINNER */
  .spin-wrap{display:none;align-items:center;justify-content:center;gap:12px;padding:16px;background:rgba(56,139,253,.08);border-radius:12px;border:1px solid rgba(56,139,253,.2)}
  .spin-wrap.show{display:flex}
  .spinner{width:22px;height:22px;border:2.5px solid rgba(56,139,253,.3);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0}
  .spin-text{font-size:13px;color:var(--blue);font-weight:600}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* OCR RESULT BOX */
  .ocr-result{display:none;flex-direction:column;gap:8px;padding:14px;background:rgba(0,200,83,.06);border-radius:12px;border:1px solid rgba(0,200,83,.25)}
  .ocr-result.show{display:flex}
  .ocr-result-title{font-size:12px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:6px}
  .ocr-row{display:flex;gap:10px;align-items:flex-start}
  .ocr-row-lbl{font-size:11px;color:var(--muted);width:80px;flex-shrink:0;padding-top:2px}
  .ocr-row-val{font-size:13px;font-weight:600;word-break:break-all;font-family:'IBM Plex Mono',monospace;color:var(--text)}
  .ocr-retry{font-size:12px;color:var(--blue);text-decoration:underline;cursor:pointer;margin-top:4px;text-align:center}

  /* FORM */
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
  .field label span{color:var(--red)}
  .field-row{display:flex;gap:8px;align-items:flex-end}
  .field-row .field{flex:1}
  input,select{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:11px 14px;font-family:'Sarabun',sans-serif;font-size:15px;color:var(--text);outline:none;transition:border-color .2s;-webkit-appearance:none}
  input:focus,select:focus{border-color:var(--green)}
  input::placeholder{color:var(--muted)}
  input.mono{font-family:'IBM Plex Mono',monospace;font-size:13px}
  select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237d8590' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
  select option{background:var(--surface2)}
  input.ai-filled{border-color:rgba(0,200,83,.5);background:rgba(0,200,83,.04)}

  /* CONFIRM */
  .confirm-panel{background:var(--surface);border:1px solid rgba(0,200,83,.3);border-radius:16px;overflow:hidden;margin-bottom:16px;animation:fadeIn .3s ease}
  .confirm-hdr{padding:14px 16px;background:rgba(0,200,83,.1);border-bottom:1px solid rgba(0,200,83,.2);font-weight:700;font-size:14px;color:var(--green)}
  .confirm-row{display:flex;padding:11px 16px;border-bottom:1px solid var(--border);gap:12px}
  .confirm-row:last-child{border-bottom:none}
  .confirm-key{font-size:12px;color:var(--muted);width:90px;flex-shrink:0;padding-top:2px}
  .confirm-val{font-size:14px;font-weight:500;word-break:break-all}
  .confirm-val.mono{font-family:'IBM Plex Mono',monospace;font-size:13px}

  /* STATUS */
  .sbar{margin-bottom:16px;border-radius:10px;padding:12px 14px;font-size:13px;display:flex;align-items:center;gap:8px;animation:fadeIn .3s ease;line-height:1.5}
  .sbar.error{background:rgba(248,81,73,.1);border:1px solid rgba(248,81,73,.3);color:var(--red)}
  .sbar.success{background:rgba(0,200,83,.1);border:1px solid rgba(0,200,83,.3);color:var(--green)}
  .sbar.info{background:rgba(56,139,253,.1);border:1px solid rgba(56,139,253,.3);color:var(--blue)}
  .sbar.warning{background:rgba(210,153,34,.1);border:1px solid rgba(210,153,34,.3);color:var(--yellow)}
  .phone-hint{font-size:11px;margin-top:3px}

  /* UTILS */
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.08);opacity:.7}}
  .hidden{display:none!important}
  .mt8{margin-top:8px}
  #photo-file{display:none}

  /* QR / LIVE SCANNER */
  .scan-tabs{display:flex;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:3px;gap:3px;margin-bottom:14px}
  .scan-tab{flex:1;padding:8px 4px;text-align:center;font-size:12px;font-weight:600;color:var(--muted);border-radius:8px;cursor:pointer;transition:all .2s;border:none;background:none;font-family:'Sarabun',sans-serif}
  .scan-tab.active{background:var(--surface);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.3)}
  .qr-wrap{position:relative;width:100%;aspect-ratio:1/1;background:#000;border-radius:12px;overflow:hidden;display:none}
  .qr-wrap.show{display:block}
  #qr-video{width:100%;height:100%;object-fit:cover;display:block}
  .qr-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .qr-frame{width:60%;aspect-ratio:1/1;position:relative}
  .qr-frame::before,.qr-frame::after,.qr-fi::before,.qr-fi::after{content:'';position:absolute;width:24px;height:24px;border-color:var(--green);border-style:solid}
  .qr-frame::before{top:0;left:0;border-width:3px 0 0 3px}
  .qr-frame::after{top:0;right:0;border-width:3px 3px 0 0}
  .qr-fi::before{bottom:0;left:0;border-width:0 0 3px 3px}
  .qr-fi::after{bottom:0;right:0;border-width:0 3px 3px 0}
  .qr-scan-line{position:absolute;left:5%;right:5%;height:2px;background:linear-gradient(90deg,transparent,var(--green),transparent);animation:qrScan 2s ease-in-out infinite;box-shadow:0 0 8px var(--green)}
  @keyframes qrScan{0%,100%{top:8%}50%{top:88%}}
  .qr-status{position:absolute;bottom:12px;left:0;right:0;text-align:center;font-size:12px;color:rgba(255,255,255,.8);background:rgba(0,0,0,.5);padding:6px;backdrop-filter:blur(4px)}
  .qr-stop-btn{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:20px;padding:6px 12px;font-size:12px;cursor:pointer;backdrop-filter:blur(4px);font-family:'Sarabun',sans-serif}
</style>
</head>
<body>

<!-- LOADING -->
<div id="ov-load" class="ov">
  <div class="ov-icon load">üì¶</div>
  <div class="ov-title blue" id="load-txt">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</div>
</div>

<!-- BLOCKED -->
<div id="ov-block" class="ov hidden">
  <div class="ov-icon block">üö´</div>
  <div class="ov-title red">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
  <div class="info-card"><div class="lbl">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div><div class="val" id="block-name">‚Äî</div></div>
  <div class="alert red" id="block-reason">‚Äî</div>
  <div class="alert muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‡πÉ‡∏ô LINE Chat<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô</div>
  <button class="btn btn-secondary" style="max-width:200px" onclick="liff.closeWindow()">‚úï ‡∏õ‡∏¥‡∏î</button>
</div>

<!-- SUCCESS -->
<div id="ov-ok" class="ov hidden">
  <div class="ov-icon ok">‚úÖ</div>
  <div class="ov-title green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
  <div class="success-id" id="ok-tracking">‚Äî</div>
  <div class="alert green">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE Bot ‡πÅ‡∏•‡πâ‡∏ß<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó</div>
  <button class="btn btn-secondary" style="max-width:240px" onclick="resetAll()">üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
  <button class="btn btn-primary"   style="max-width:240px" onclick="liff.closeWindow()">‚úîÔ∏è ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏ä‡∏ó</button>
</div>

<!-- HEADER -->
<div class="hdr">
  <div class="hdr-icon">üì¶</div>
  <div>
    <div class="hdr-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏Ç‡πâ‡∏≤</div>
    <div class="hdr-sub">‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ ‡∏Å‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£ ‡∏õ.5</div>
  </div>
  <div class="badge" id="badge-name">...</div>
</div>

<div class="content">
  <!-- STEPS -->
  <div class="steps">
    <div class="step active" id="step1"><span class="step-num">1</span>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
    <div class="step"        id="step2"><span class="step-num">2</span>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
    <div class="step"        id="step3"><span class="step-num">3</span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
  </div>

  <!-- STATUS BAR -->
  <div class="sbar info hidden" id="sbar">
    <span id="sbar-icon">‚ÑπÔ∏è</span>
    <span id="sbar-txt"></span>
  </div>

  <!-- ====== STEP 1: ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ OCR ====== -->
  <div id="sec-scan">
    <div class="card">
      <div class="card-hdr">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏õ‡πâ‡∏≤‡∏¢‡∏û‡∏±‡∏™‡∏î‡∏∏</div>
      <div class="card-body">

        <!-- TABS: QR Live / ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ OCR -->
        <div class="scan-tabs">
          <button class="scan-tab active" id="tab-qr"  onclick="switchTab('qr')">üì± ‡∏™‡πÅ‡∏Å‡∏ô QR / ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</button>
          <button class="scan-tab"        id="tab-ocr" onclick="switchTab('ocr')">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ + AI ‡∏≠‡πà‡∏≤‡∏ô</button>
        </div>

        <!-- === TAB 1: QR LIVE === -->
        <div id="panel-qr">
          <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á live -->
          <div class="qr-wrap" id="qr-wrap">
            <video id="qr-video" autoplay muted playsinline webkit-playsinline></video>
            <div class="qr-overlay">
              <div class="qr-frame"><div class="qr-fi"></div><div class="qr-scan-line"></div></div>
            </div>
            <div class="qr-status" id="qr-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ QR / ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î...</div>
            <button class="qr-stop-btn" onclick="stopQR()">‚úï ‡∏´‡∏¢‡∏∏‡∏î</button>
          </div>

          <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á -->
          <div class="ocr-zone" id="qr-start-zone" onclick="startQR()">
            <div class="ocr-zone-icon">üì±</div>
            <div class="ocr-zone-title">‡∏Å‡∏î‡∏™‡πÅ‡∏Å‡∏ô QR Code / ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</div>
            <div class="ocr-zone-sub">‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á live ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ<br>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö QR, CODE128, EAN, Data Matrix</div>
          </div>

          <div class="spin-wrap" id="qr-spin">
            <div class="spinner"></div>
            <div class="spin-text" id="qr-spin-txt">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>
          </div>
        </div>

        <!-- === TAB 2: OCR ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ === -->
        <div id="panel-ocr" class="hidden">
          <!-- Preview ‡∏£‡∏π‡∏õ -->
          <div class="preview-wrap" id="preview-wrap">
            <img id="preview-img" src="" alt="">
            <div class="preview-badge" id="preview-badge">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢</div>
          </div>

          <div class="ocr-zone" id="ocr-zone" onclick="triggerCamera()">
            <div class="ocr-zone-icon">üì∑</div>
            <div class="ocr-zone-title">‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏û‡∏±‡∏™‡∏î‡∏∏</div>
            <div class="ocr-zone-sub">‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô<strong>‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î + ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö + ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</strong><br>‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Äî AI ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
          </div>

          <div class="spin-wrap" id="spin-wrap">
            <div class="spinner"></div>
            <div class="spin-text">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ...</div>
          </div>
        </div>

        <!-- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á 2 tab) -->
        <div class="ocr-result" id="ocr-result">
          <div class="ocr-result-title">‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß</div>
          <div class="ocr-row"><div class="ocr-row-lbl">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</div><div class="ocr-row-val" id="ocr-tracking">‚Äî</div></div>
          <div class="ocr-row"><div class="ocr-row-lbl">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</div><div class="ocr-row-val" id="ocr-name">‚Äî</div></div>
          <div class="ocr-row"><div class="ocr-row-lbl">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div><div class="ocr-row-val" id="ocr-phone">‚Äî</div></div>
          <div class="ocr-retry" id="ocr-retry-btn">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà / ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
        </div>

        <!-- input file ‡∏ã‡πà‡∏≠‡∏ô -->
        <input type="file" id="photo-file" accept="image/*" capture="environment">
      </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á -->
    <button class="btn btn-secondary" id="btn-manual" onclick="showManual()">‚å®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô</button>

    <div id="manual-box" class="card hidden" style="margin-top:12px">
      <div class="card-hdr">‚å®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</div>
      <div class="card-body">
        <div class="field">
          <label>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ <span>*</span></label>
          <input type="text" id="manual-val" class="mono" placeholder="‡πÄ‡∏ä‡πà‡∏ô TH123456789TH"
                 autocomplete="off" autocapitalize="characters"
                 oninput="onManualInput()"
                 onkeydown="if(event.key==='Enter') confirmManual()">
        </div>
        <button class="btn btn-primary" onclick="confirmManual()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ ‚ûú</button>
        <button class="btn btn-secondary" onclick="hideManual()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>

    <button class="btn btn-primary mt8 hidden" id="btn-next1" onclick="goStep2()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚ûú</button>
  </div>

  <!-- ====== STEP 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ====== -->
  <div id="sec-form" class="hidden">
    <div class="card">
      <div class="card-hdr">üì¶ ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</div>
      <div style="padding:14px 16px">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:15px;font-weight:600;color:var(--green)" id="form-tracking-preview">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <div class="card-hdr">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö <span style="font-size:11px;color:var(--green);font-weight:400;margin-left:6px">‚ú® AI ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</span></div>
      <div class="card-body">
        <div class="field">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏¢‡∏® ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö <span>*</span></label>
          <input type="text" id="f-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à.‡∏™.‡∏≠. ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" oninput="checkForm()">
        </div>
        <div class="field">
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span>*</span></label>
          <div class="field-row">
            <div class="field">
              <input type="tel" id="f-phone" placeholder="0801234567" maxlength="10" oninput="checkForm()">
            </div>
            <button class="btn btn-secondary" style="width:auto;padding:11px 14px;white-space:nowrap;font-size:13px;flex-shrink:0" onclick="setNoPhone()">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå</button>
          </div>
          <div class="phone-hint" id="phone-hint"></div>
        </div>
        <div class="field">
          <label>‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏û‡∏±‡∏™‡∏î‡∏∏ <span>*</span></label>
          <select id="f-type" onchange="checkForm()">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏û‡∏±‡∏™‡∏î‡∏∏ --</option>
            <option value="‡∏Å‡∏•‡πà‡∏≠‡∏á">üì¶ ‡∏Å‡∏•‡πà‡∏≠‡∏á</option>
            <option value="‡∏ã‡∏≠‡∏á">üì® ‡∏ã‡∏≠‡∏á</option>
            <option value="‡∏ñ‡∏∏‡∏á">üõçÔ∏è ‡∏ñ‡∏∏‡∏á</option>
            <option value="‡∏°‡πâ‡∏ß‡∏ô">üßª ‡∏°‡πâ‡∏ß‡∏ô</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">üì¶ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å) -->
        <button class="btn btn-secondary" style="font-size:13px;padding:10px" onclick="retakePhoto()">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary btn-back" onclick="goStep1()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
      <button class="btn btn-primary" id="btn-next2" onclick="goStep3()" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚ûú</button>
    </div>
  </div>

  <!-- ====== STEP 3: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ====== -->
  <div id="sec-confirm" class="hidden">
    <div class="confirm-panel">
      <div class="confirm-hdr">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
      <div class="confirm-row"><div class="confirm-key">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</div><div class="confirm-val mono" id="c-tracking">‚Äî</div></div>
      <div class="confirm-row"><div class="confirm-key">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</div><div class="confirm-val" id="c-name">‚Äî</div></div>
      <div class="confirm-row"><div class="confirm-key">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div><div class="confirm-val mono" id="c-phone">‚Äî</div></div>
      <div class="confirm-row"><div class="confirm-key">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞</div><div class="confirm-val" id="c-type">‚Äî</div></div>
      <div class="confirm-row"><div class="confirm-key">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢</div><div class="confirm-val" id="c-admin">‚Äî</div></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary btn-back" onclick="goStep2()">‚Üê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <button class="btn btn-primary" id="btn-submit" onclick="submitPackage()">üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏</button>
    </div>
  </div>

</div><!-- end .content -->

<script>
// ============================================================
// CONFIG
// ============================================================
const LIFF_ID = '2009243376-Hd3IygRL';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwy8AoWKvlT8JvV76UdiMAmCE41tZDn_TFK705CTXWiF5vV5UewKPAbdP7dFCiIZUP4JQ/exec';

// ============================================================
// STATE
// ============================================================
const S = {
  tracking:'', name:'', phone:'', type:'',
  adminName:'', adminUserId:'', adminType:'',
  qrStream:null, qrRunning:false, qrDetector:null,
  activeTab:'qr'
};
const $ = id => document.getElementById(id);

// ============================================================
// INIT
// ============================================================
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    const p = await liff.getProfile();
    S.adminName   = p.displayName;
    S.adminUserId = p.userId;
    setLoad('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...');
    const auth = await checkAuth(p.userId);
    if (!auth.isAdmin) {
      $('block-name').textContent   = p.displayName;
      $('block-reason').textContent = auth.reason || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
      show('ov-block'); return;
    }
    S.adminType = auth.adminType || 'STAFF';
    $('badge-name').textContent = p.displayName;
    if (S.adminType === 'MAIN_ADMIN') $('badge-name').classList.add('main');
    $('c-admin').textContent = p.displayName +
      (S.adminType === 'MAIN_ADMIN' ? ' (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å)' : ' (‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà)');
    show('main');

    // ‡∏ú‡∏π‡∏Å file inputs
    $('qr-file').addEventListener('change',  onQRPhoto);
    $('photo-file').addEventListener('change', onOCRPhoto);
    $('ocr-retry-btn').addEventListener('click', onRetry);

    // ‡∏ï‡∏£‡∏ß‡∏à BarcodeDetector (live scan)
    if (typeof BarcodeDetector !== 'undefined') {
      try {
        const fmts = await BarcodeDetector.getSupportedFormats();
        if (fmts.length > 0) {
          S.qrDetector = new BarcodeDetector({
            formats: ['qr_code','code_128','code_39','ean_13','ean_8',
                      'data_matrix','itf','pdf417','upc_a','upc_e','aztec']
          });
        }
      } catch(e) {}
    }
    // Tab QR ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏°‡∏≠ (live scan ‡πÄ‡∏õ‡πá‡∏ô bonus ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ)
    updateQRZoneUI();

  } catch(e) {
    setLoad('‚ùå ' + e.message);
    setTimeout(() => show('main'), 1500);
  }
}

function updateQRZoneUI() {
  // ‡∏ñ‡πâ‡∏≤ browser ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö live ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å, ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
  if (S.qrDetector) {
    $('qr-live-btn').classList.remove('hidden');
    $('qr-zone-sub').textContent = '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î/QR Code ‚Äî AI ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡πâ\n‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î "‡∏™‡πÅ‡∏Å‡∏ô Live" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö real-time';
  } else {
    $('qr-live-btn').classList.add('hidden');
    $('qr-zone-sub').textContent = '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‡∏´‡∏£‡∏∑‡∏≠ QR Code\nAI ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
  }
}

async function checkAuth(userId) {
  try {
    const r = await fetch(`${GAS_URL}?action=check_admin&userId=${encodeURIComponent(userId)}`);
    return r.ok ? await r.json() : { isAdmin:false, reason:'HTTP '+r.status };
  } catch(e) { return { isAdmin:false, reason:e.message }; }
}
function show(s) {
  ['ov-load','ov-block','ov-ok'].forEach(x => $(x).classList.add('hidden'));
  if (s !== 'main') $(s).classList.remove('hidden');
}
function setLoad(t) { $('load-txt').textContent = t; }

// ============================================================
// TABS
// ============================================================
function switchTab(tab) {
  S.activeTab = tab;
  stopLive();
  $('tab-qr').classList.toggle('active',  tab === 'qr');
  $('tab-ocr').classList.toggle('active', tab === 'ocr');
  $('panel-qr').classList.toggle('hidden',  tab !== 'qr');
  $('panel-ocr').classList.toggle('hidden', tab !== 'ocr');
}

function onRetry() {
  $('ocr-result').classList.remove('show');
  $('btn-next1').classList.add('hidden');
  clearSbar();
  if (S.activeTab === 'qr') {
    $('qr-zone').style.display = '';
    $('qr-wrap').classList.remove('show');
  }
}

// ============================================================
// TAB QR: ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ ‚Üí decode tracking ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏£‡πá‡∏ß + ‡πÅ‡∏°‡πà‡∏ô)
// ============================================================
function triggerQRPhoto() {
  $('qr-file').value = '';
  $('qr-file').click();
}

async function onQRPhoto(e) {
  const file = e.target.files && e.target.files[0];
  if (!file) return;

  setQRZone('scanning');
  $('ocr-result').classList.remove('show');
  $('qr-spin').classList.add('show');
  $('qr-spin-txt').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î...';
  $('btn-next1').classList.add('hidden');
  clearSbar();

  try {
    const url = URL.createObjectURL(file);
    let tracking = null;

    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: BarcodeDetector ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (Android)
    if (S.qrDetector) {
      try {
        const img = new Image();
        await new Promise((res, rej) => { img.onload=res; img.onerror=rej; img.src=url; });
        const codes = await S.qrDetector.detect(img);
        if (codes.length > 0) tracking = parseTracking(codes[0].rawValue);
      } catch(e) {}
    }

    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏™‡πà‡∏á Claude ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ tracking
    if (!tracking) {
      $('qr-spin-txt').textContent = 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î...';
      const b64 = await resizeToBase64(file, 1200);
      const result = await callGAS('ocr_barcode', { imageBase64:b64, mimeType:'image/jpeg' });
      tracking = result.tracking || null;
    }

    URL.revokeObjectURL(url);

    if (tracking) {
      S.tracking = tracking;
      S.name = ''; S.phone = ''; S.type = '';
      $('ocr-tracking').textContent = tracking;
      $('ocr-name').textContent     = '(‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)';
      $('ocr-phone').textContent    = '(‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)';
      $('ocr-result').classList.add('show');
      setQRZone('done');
      $('btn-next1').classList.remove('hidden');
      setSbar('success', '‚úÖ ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: ' + tracking);
    } else {
      setQRZone('idle');
      setSbar('warning', '‚ö†Ô∏è ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏û ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠');
    }
  } catch(err) {
    setQRZone('idle');
    setSbar('error', '‚ùå ' + err.message);
  } finally {
    $('qr-spin').classList.remove('show');
  }
}

function parseTracking(raw) {
  let t = (raw || '').trim();
  if (t.startsWith('http')) {
    try { t = new URL(t).pathname.split('/').filter(Boolean).pop() || t; } catch(e) {}
  }
  if (t.startsWith('{')) {
    try { const o = JSON.parse(t); t = o.tracking || o.trackingNumber || o.id || t; } catch(e) {}
  }
  return t.length >= 4 ? t : null;
}

function setQRZone(state) {
  const zone = $('qr-zone');
  if (state === 'scanning') {
    zone.style.display = '';
    zone.className = 'ocr-zone scanning';
  } else if (state === 'done') {
    zone.className = 'ocr-zone done';
    zone.innerHTML = '<div class="ocr-zone-icon">‚úÖ</div>'
      + '<div class="ocr-zone-title" style="color:var(--green)">‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>'
      + '<div class="ocr-zone-sub">‡∏Å‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö<br>‡∏´‡∏£‡∏∑‡∏≠ <u onclick="triggerQRPhoto()" style="color:var(--blue);cursor:pointer">‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</u></div>';
  } else {
    zone.style.display = '';
    zone.className = 'ocr-zone';
    zone.innerHTML = '<div class="ocr-zone-icon">üî≤</div>'
      + '<div class="ocr-zone-title">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î / QR Code</div>'
      + '<div class="ocr-zone-sub" id="qr-zone-sub">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‡∏´‡∏£‡∏∑‡∏≠ QR Code<br>AI ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>';
    zone.onclick = triggerQRPhoto;
    updateQRZoneUI();
  }
}

// ============================================================
// LIVE SCAN (bonus ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Android)
// ============================================================
async function startLive() {
  if (!S.qrDetector) return;
  $('qr-zone').style.display = 'none';
  $('qr-spin').classList.add('show');
  $('qr-spin-txt').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
  try {
    S.qrStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} },
      audio: false
    });
    const vid = $('qr-video');
    vid.srcObject = S.qrStream;
    await vid.play();
    $('qr-wrap').classList.add('show');
    $('qr-spin').classList.remove('show');
    $('qr-status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î / QR Code...';
    S.qrRunning = true;
    runLiveDetect(vid);
  } catch(err) {
    $('qr-spin').classList.remove('show');
    $('qr-zone').style.display = '';
    setSbar('warning', '‚ö†Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ó‡∏ô');
  }
}

async function runLiveDetect(vid) {
  while (S.qrRunning) {
    try {
      if (vid.readyState >= 2) {
        const codes = await S.qrDetector.detect(vid);
        if (codes.length > 0) {
          const tracking = parseTracking(codes[0].rawValue);
          if (tracking) {
            S.qrRunning = false;
            stopLive();
            S.tracking = tracking;
            S.name = ''; S.phone = ''; S.type = '';
            $('ocr-tracking').textContent = tracking;
            $('ocr-name').textContent     = '(‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)';
            $('ocr-phone').textContent    = '(‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)';
            $('ocr-result').classList.add('show');
            setQRZone('done');
            $('btn-next1').classList.remove('hidden');
            setSbar('success', '‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ: ' + tracking);
            return;
          }
        }
      }
    } catch(e) {}
    await new Promise(r => setTimeout(r, 100));
  }
}

function stopLive() {
  S.qrRunning = false;
  if (S.qrStream) { S.qrStream.getTracks().forEach(t => t.stop()); S.qrStream = null; }
  $('qr-video').srcObject = null;
  $('qr-wrap').classList.remove('show');
  $('qr-spin').classList.remove('show');
}

// ============================================================
// TAB OCR: ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ ‚Üí Claude ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á
// ============================================================
function triggerCamera() {
  $('photo-file').value = '';
  $('photo-file').click();
}

async function onOCRPhoto(e) {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  if (S.activeTab !== 'ocr') switchTab('ocr');

  const url = URL.createObjectURL(file);
  $('preview-img').src = url;
  $('preview-wrap').classList.add('show');
  $('preview-badge').textContent = 'üì∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
  $('ocr-zone').classList.add('scanning');
  $('ocr-result').classList.remove('show');
  $('spin-wrap').classList.add('show');
  $('btn-next1').classList.add('hidden');
  clearSbar();

  try {
    const b64 = await resizeToBase64(file, 1200);

    // ‡∏•‡∏≠‡∏á BarcodeDetector ‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    let qrTracking = null;
    if (S.qrDetector) {
      try {
        const img = new Image();
        await new Promise((res, rej) => { img.onload=res; img.onerror=rej; img.src=url; });
        const codes = await S.qrDetector.detect(img);
        if (codes.length > 0) qrTracking = parseTracking(codes[0].rawValue);
      } catch(e) {}
    }

    // OCR ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠ + ‡πÄ‡∏ö‡∏≠‡∏£‡πå + (tracking ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
    const result = await callGAS('ocr_label', { imageBase64:b64, mimeType:'image/jpeg' });
    if (qrTracking) result.tracking = qrTracking;

    $('ocr-tracking').textContent = result.tracking || '‚Äî';
    $('ocr-name').textContent     = result.name     || '‚Äî';
    $('ocr-phone').textContent    = result.phone    || '‚Äî';
    $('ocr-result').classList.add('show');
    $('ocr-zone').className = 'ocr-zone done';
    $('ocr-zone').innerHTML = '<div class="ocr-zone-icon">‚úÖ</div>'
      + '<div class="ocr-zone-title" style="color:var(--green)">‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>'
      + '<div class="ocr-zone-sub">‡∏Å‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö<br>‡∏´‡∏£‡∏∑‡∏≠ <u onclick="triggerCamera()" style="color:var(--blue);cursor:pointer">‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</u></div>';
    $('preview-badge').textContent = '‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';

    S.tracking = (result.tracking || '').trim();
    S.name     = (result.name     || '').trim();
    S.phone    = (result.phone    || '').replace(/\D/g,'').slice(0,10);
    S.type     = result.type || '';

    if (S.tracking && S.tracking !== '‡πÑ‡∏°‡πà‡∏û‡∏ö') {
      $('btn-next1').classList.remove('hidden');
      setSbar('success', '‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: ' + S.tracking);
    } else {
      setSbar('warning', '‚ö†Ô∏è ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î/QR ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á');
    }
  } catch(err) {
    $('ocr-zone').className = 'ocr-zone';
    $('ocr-zone').innerHTML = '<div class="ocr-zone-icon">üì∑</div>'
      + '<div class="ocr-zone-title">‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>'
      + '<div class="ocr-zone-sub">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‚Äî ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>';
    setSbar('error', '‚ùå ' + err.message);
    $('preview-badge').textContent = '‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
  } finally {
    $('spin-wrap').classList.remove('show');
    URL.revokeObjectURL(url);
  }
}

// ============================================================
// GAS CALL (FormData ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ CORS preflight)
// ============================================================
async function callGAS(action, extra) {
  const form = new FormData();
  form.append('payload', JSON.stringify({ action, ...extra }));
  const resp = await fetch(GAS_URL, { method:'POST', body:form });
  if (!resp.ok) throw new Error('GAS HTTP ' + resp.status);
  const data = await resp.json();
  if (data.status !== 'ok') throw new Error(data.message || action + ' ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
  return data.result;
}

async function resizeToBase64(file, maxW) {
  return new Promise((res, rej) => {
    const img = new Image(), url = URL.createObjectURL(file);
    img.onload = () => {
      let w = img.width, h = img.height;
      if (w > maxW) { h = Math.round(h * maxW / w); w = maxW; }
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      URL.revokeObjectURL(url);
      res(c.toDataURL('image/jpeg', 0.88).split(',')[1]);
    };
    img.onerror = () => { URL.revokeObjectURL(url); rej(new Error('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ')); };
    img.src = url;
  });
}

// ============================================================
// MANUAL
// ============================================================
function showManual() {
  $('manual-box').classList.remove('hidden');
  $('btn-manual').classList.add('hidden');
  setTimeout(() => $('manual-val').focus(), 100);
}
function hideManual() {
  $('manual-box').classList.add('hidden');
  $('btn-manual').classList.remove('hidden');
  $('manual-val').value = '';
}
function onManualInput() {
  const v = $('manual-val').value.trim();
  $('btn-next1').classList.toggle('hidden', v.length < 4);
  if (v.length >= 4) S.tracking = v.toUpperCase();
}
function confirmManual() {
  const v = $('manual-val').value.trim().toUpperCase();
  if (v.length < 4) { setSbar('error','‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß'); return; }
  S.tracking = v; hideManual();
  $('btn-next1').classList.remove('hidden');
  setSbar('success', '‚úÖ ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: ' + v);
}
function retakePhoto() {
  goStep1();
  setTimeout(() => { if (S.activeTab === 'qr') triggerQRPhoto(); else triggerCamera(); }, 200);
}

// ============================================================
// NAVIGATION
// ============================================================
function setStep(n) {
  [1,2,3].forEach(i => {
    const el = $('step'+i); el.classList.remove('active','done');
    if (i < n) el.classList.add('done'); else if (i === n) el.classList.add('active');
  });
}
function goStep1() {
  stopLive();
  $('sec-form').classList.add('hidden');
  $('sec-confirm').classList.add('hidden');
  $('sec-scan').classList.remove('hidden');
  setStep(1); clearSbar();
}
function goStep2() {
  if (!S.tracking || S.tracking === '‡πÑ‡∏°‡πà‡∏û‡∏ö') { setSbar('error','‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏'); return; }
  stopLive();
  $('form-tracking-preview').textContent = S.tracking;
  const skip = ['‡πÑ‡∏°‡πà‡∏û‡∏ö','(‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)',''];
  if (S.name && !skip.includes(S.name)) {
    $('f-name').value = S.name; $('f-name').classList.add('ai-filled');
  } else { $('f-name').value = ''; $('f-name').classList.remove('ai-filled'); }
  if (S.phone && S.phone.length >= 9) {
    $('f-phone').value = S.phone; $('f-phone').classList.add('ai-filled');
  } else { $('f-phone').value = ''; $('f-phone').classList.remove('ai-filled'); }
  $('f-type').value = {'‡∏Å‡∏•‡πà‡∏≠‡∏á':'‡∏Å‡∏•‡πà‡∏≠‡∏á','‡∏ã‡∏≠‡∏á':'‡∏ã‡∏≠‡∏á','‡∏ñ‡∏∏‡∏á':'‡∏ñ‡∏∏‡∏á','‡∏°‡πâ‡∏ß‡∏ô':'‡∏°‡πâ‡∏ß‡∏ô'}[S.type] || '';
  $('sec-scan').classList.add('hidden');
  $('sec-confirm').classList.add('hidden');
  $('sec-form').classList.remove('hidden');
  setStep(2); clearSbar(); checkForm();
}
function goStep3() {
  const name=$('f-name').value.trim(), phone=$('f-phone').value.trim(), type=$('f-type').value;
  if (!name||!phone||!type) { setSbar('error','‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
  $('c-tracking').textContent=S.tracking; $('c-name').textContent=name;
  $('c-phone').textContent=phone; $('c-type').textContent=type;
  $('sec-form').classList.add('hidden');
  $('sec-confirm').classList.remove('hidden');
  setStep(3); clearSbar();
}

// ============================================================
// FORM
// ============================================================
function checkForm() {
  const name=$('f-name').value.trim(), phone=$('f-phone').value.trim(), type=$('f-type').value;
  const ok = name.length>=2 && (/^0[689]\d{8}$/.test(phone.replace(/\D/g,''))||phone==='‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå') && type!=='';
  $('btn-next2').disabled = !ok;
  const hint = $('phone-hint');
  if (phone && phone!=='‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå') {
    const c = phone.replace(/\D/g,'');
    if (/^0[689]\d{8}$/.test(c))  { hint.style.color='var(--green)';  hint.textContent='‚úì ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; }
    else if (c.length>=4)          { hint.style.color='var(--yellow)'; hint.textContent='‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô 06/08/09 10 ‡∏´‡∏•‡∏±‡∏Å'; }
    else                            { hint.textContent=''; }
  } else { hint.textContent=''; }
}
function setNoPhone() { $('f-phone').value='‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå'; $('f-phone').classList.remove('ai-filled'); checkForm(); }

// ============================================================
// SUBMIT
// ============================================================
async function submitPackage() {
  const btn=$('btn-submit');
  btn.disabled=true; btn.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  const tracking=S.tracking, name=$('f-name').value.trim(), phone=$('f-phone').value.trim(), type=$('f-type').value;
  try {
    await liff.sendMessages([{ type:'text', text:`${tracking}\n${name}\n${phone}\n${type}` }]);
    $('ok-tracking').textContent=tracking; show('ov-ok');
  } catch(e) {
    try {
      await callGAS('liff_submit',{ userId:S.adminUserId, tracking, name, phone, type });
      $('ok-tracking').textContent=tracking; show('ov-ok');
    } catch(e2) {
      setSbar('error','‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e2.message);
      btn.disabled=false; btn.textContent='üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏';
    }
  }
}

// ============================================================
// RESET
// ============================================================
function resetAll() {
  S.tracking=''; S.name=''; S.phone=''; S.type='';
  stopLive();
  $('f-name').value=''; $('f-phone').value=''; $('f-type').value='';
  $('f-name').classList.remove('ai-filled'); $('f-phone').classList.remove('ai-filled');
  $('preview-wrap').classList.remove('show');
  $('ocr-result').classList.remove('show');
  $('spin-wrap').classList.remove('show');
  $('qr-spin').classList.remove('show');
  $('qr-wrap').classList.remove('show');
  $('btn-next1').classList.add('hidden');
  $('manual-box').classList.add('hidden');
  $('btn-manual').classList.remove('hidden');
  $('ocr-zone').className='ocr-zone';
  $('ocr-zone').innerHTML='<div class="ocr-zone-icon">üì∑</div>'
    +'<div class="ocr-zone-title">‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏û‡∏±‡∏™‡∏î‡∏∏</div>'
    +'<div class="ocr-zone-sub">‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô<strong>‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î + ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö + ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</strong><br>‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Äî AI ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>';
  setQRZone('idle');
  show('main'); goStep1();
}

function setSbar(type, text) {
  if (!type) { clearSbar(); return; }
  const b=$('sbar'); b.className='sbar '+type; b.classList.remove('hidden');
  $('sbar-icon').textContent={error:'‚ùå',success:'‚úÖ',info:'‚ÑπÔ∏è',warning:'‚ö†Ô∏è'}[type]||'‚ÑπÔ∏è';
  $('sbar-txt').textContent=text;
}
function clearSbar() { $('sbar').classList.add('hidden'); }

init();
</script>
</body>
</html>
