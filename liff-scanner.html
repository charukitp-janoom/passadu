<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏</title>
<!-- LIFF SDK ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ barcode library ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap');

  :root {
    --green: #00c853;
    --green-dark: #009624;
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #21262d;
    --border: #30363d;
    --text: #e6edf3;
    --text-muted: #7d8590;
    --red: #f85149;
    --yellow: #d29922;
    --blue: #388bfd;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body { font-family:'Sarabun',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; overflow-x:hidden; }

  /* === OVERLAY SCREENS === */
  .overlay-screen {
    position:fixed; inset:0; background:var(--bg);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:20px; padding:40px; text-align:center; z-index:9999;
  }
  .overlay-screen.hidden { display:none; }
  .overlay-icon { width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; }
  .overlay-icon.loading { background:rgba(56,139,253,0.1); border:2px solid var(--blue); animation:pulse 1.5s ease-in-out infinite; }
  .overlay-icon.blocked { background:rgba(248,81,73,0.15); border:2px solid var(--red); }
  .overlay-icon.success { background:rgba(0,200,83,0.15);  border:2px solid var(--green); }
  .overlay-title { font-size:20px; font-weight:700; }
  .overlay-title.red   { color:var(--red); }
  .overlay-title.green { color:var(--green); }
  .overlay-title.blue  { color:var(--blue); }
  .info-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:16px 24px; width:100%; max-width:320px; text-align:left; }
  .info-card .label { font-size:11px; color:var(--text-muted); margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px; }
  .info-card .value { font-size:15px; font-weight:600; }
  .alert-box { border-radius:10px; padding:14px 16px; font-size:13px; line-height:1.7; width:100%; max-width:320px; white-space:pre-line; text-align:left; }
  .alert-box.red   { background:rgba(248,81,73,0.1);  border:1px solid rgba(248,81,73,0.3);  color:var(--red); }
  .alert-box.green { background:rgba(0,200,83,0.1);   border:1px solid rgba(0,200,83,0.3);   color:var(--green); }
  .alert-box.muted { background:var(--surface);       border:1px solid var(--border);         color:var(--text-muted); text-align:center; }
  .success-id-box { font-family:'IBM Plex Mono',monospace; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:12px 24px; font-size:15px; font-weight:600; letter-spacing:1px; word-break:break-all; max-width:320px; width:100%; text-align:center; }

  /* === HEADER === */
  .header { background:var(--surface); border-bottom:1px solid var(--border); padding:14px 20px; display:flex; align-items:center; gap:12px; position:sticky; top:0; z-index:100; }
  .header-icon { width:36px; height:36px; background:linear-gradient(135deg,var(--green),var(--green-dark)); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
  .header-title { font-size:16px; font-weight:700; }
  .header-sub   { font-size:11px; color:var(--text-muted); margin-top:1px; }
  .admin-badge { margin-left:auto; background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:4px 10px; font-size:11px; color:var(--text-muted); font-family:'IBM Plex Mono',monospace; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:140px; }
  .admin-badge.main { border-color:rgba(0,200,83,0.5); color:var(--green); }

  /* === MAIN CONTENT === */
  .content { padding:20px 16px 40px; max-width:500px; margin:0 auto; }

  /* === STEPS === */
  .steps { display:flex; margin-bottom:24px; background:var(--surface); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
  .step { flex:1; padding:10px 4px; text-align:center; font-size:11px; color:var(--text-muted); transition:all 0.3s; border-right:1px solid var(--border); }
  .step:last-child { border-right:none; }
  .step.active { background:rgba(0,200,83,0.1); color:var(--green); font-weight:600; }
  .step.done   { color:var(--green); }
  .step-num    { display:block; font-size:16px; font-weight:700; margin-bottom:2px; font-family:'IBM Plex Mono',monospace; }

  /* === SCANNER === */
  .scanner-box { background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:16px; }
  .scanner-header { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; font-weight:600; font-size:14px; }

  .camera-wrap { position:relative; background:#000; width:100%; aspect-ratio:4/3; overflow:hidden; }
  #camera-video { width:100%; height:100%; object-fit:cover; display:block; }
  /* scan frame overlay */
  .scan-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
  .scan-frame { width:70%; aspect-ratio:3/1; position:relative; }
  .scan-frame::before,.scan-frame::after,.scan-frame-inner::before,.scan-frame-inner::after { content:''; position:absolute; width:22px; height:22px; border-color:var(--green); border-style:solid; }
  .scan-frame::before       { top:0;    left:0;  border-width:2px 0 0 2px; }
  .scan-frame::after        { top:0;    right:0; border-width:2px 2px 0 0; }
  .scan-frame-inner::before { bottom:0; left:0;  border-width:0 0 2px 2px; }
  .scan-frame-inner::after  { bottom:0; right:0; border-width:0 2px 2px 0; }
  .scan-line { position:absolute; left:0; right:0; height:2px; background:linear-gradient(90deg,transparent,var(--green),transparent); animation:scanLine 2s ease-in-out infinite; box-shadow:0 0 8px var(--green); }
  @keyframes scanLine { 0%,100%{top:5%} 50%{top:90%} }

  .camera-placeholder { aspect-ratio:4/3; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; color:var(--text-muted); font-size:13px; padding:20px; text-align:center; }
  .camera-placeholder-icon { font-size:40px; }

  /* === RESULT === */
  .result-display { padding:12px 16px; background:rgba(0,200,83,0.08); border-top:1px solid rgba(0,200,83,0.2); display:flex; align-items:center; gap:10px; animation:fadeIn 0.3s ease; }
  .result-icon  { font-size:20px; flex-shrink:0; }
  .result-text  { flex:1; }
  .result-label { font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; }
  .result-value { font-family:'IBM Plex Mono',monospace; font-size:14px; font-weight:600; color:var(--green); word-break:break-all; }
  .result-clear { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:18px; padding:4px; }

  /* === BUTTONS === */
  .btn { display:flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:14px; border:none; border-radius:10px; font-family:'Sarabun',sans-serif; font-size:15px; font-weight:600; cursor:pointer; transition:all 0.2s; -webkit-appearance:none; }
  .btn:active    { transform:scale(0.97); }
  .btn-primary   { background:var(--green); color:#000; }
  .btn-primary:hover { background:#00e676; }
  .btn-secondary { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
  .btn:disabled  { opacity:0.4; cursor:not-allowed; transform:none; }
  .btn-row { display:flex; gap:8px; }
  .btn-row .btn-back { flex:0 0 auto; width:auto; padding:14px 20px; }

  /* === FORM === */
  .form-section { background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:16px; animation:fadeIn 0.4s ease; }
  .form-header  { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; font-weight:600; font-size:14px; }
  .form-body    { padding:16px; display:flex; flex-direction:column; gap:14px; }
  .field        { display:flex; flex-direction:column; gap:6px; }
  .field label  { font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; }
  .field label span { color:var(--red); }
  .field-row    { display:flex; gap:8px; align-items:flex-end; }
  .field-row .field { flex:1; }
  input,select  { width:100%; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:11px 14px; font-family:'Sarabun',sans-serif; font-size:15px; color:var(--text); outline:none; transition:border-color 0.2s; -webkit-appearance:none; }
  input:focus,select:focus { border-color:var(--green); }
  input::placeholder { color:var(--text-muted); }
  input.mono { font-family:'IBM Plex Mono',monospace; font-size:13px; }
  select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237d8590' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 14px center; padding-right:36px; }
  select option { background:var(--surface2); }

  /* === CONFIRM === */
  .confirm-panel { background:var(--surface); border:1px solid rgba(0,200,83,0.3); border-radius:16px; overflow:hidden; margin-bottom:16px; animation:fadeIn 0.3s ease; }
  .confirm-header { padding:14px 16px; background:rgba(0,200,83,0.1); border-bottom:1px solid rgba(0,200,83,0.2); display:flex; align-items:center; gap:8px; font-weight:700; font-size:14px; color:var(--green); }
  .confirm-row { display:flex; padding:11px 16px; border-bottom:1px solid var(--border); gap:12px; }
  .confirm-row:last-child { border-bottom:none; }
  .confirm-key  { font-size:12px; color:var(--text-muted); width:90px; flex-shrink:0; padding-top:2px; }
  .confirm-val  { font-size:14px; font-weight:500; word-break:break-all; }
  .confirm-val.mono { font-family:'IBM Plex Mono',monospace; font-size:13px; }

  /* === STATUS BAR === */
  .status-bar { margin-bottom:16px; border-radius:10px; padding:12px 14px; font-size:13px; display:flex; align-items:center; gap:8px; animation:fadeIn 0.3s ease; }
  .status-bar.error   { background:rgba(248,81,73,0.1);  border:1px solid rgba(248,81,73,0.3);  color:var(--red); }
  .status-bar.success { background:rgba(0,200,83,0.1);   border:1px solid rgba(0,200,83,0.3);   color:var(--green); }
  .status-bar.info    { background:rgba(56,139,253,0.1); border:1px solid rgba(56,139,253,0.3); color:var(--blue); }
  .status-bar.warning { background:rgba(210,153,34,0.1); border:1px solid rgba(210,153,34,0.3); color:var(--yellow); }

  /* === UTILS === */
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
  @keyframes pulse  { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.08);opacity:0.7} }
  .hidden  { display:none !important; }
  .mt-8    { margin-top:8px; }
  .text-muted { color:var(--text-muted); font-size:12px; }
</style>
</head>
<body>

<!-- ============================================================ OVERLAYS ============================================================ -->

<!-- Loading -->
<div id="screen-loading" class="overlay-screen">
  <div class="overlay-icon loading">üì¶</div>
  <div class="overlay-title blue" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</div>
</div>

<!-- Blocked -->
<div id="screen-blocked" class="overlay-screen hidden">
  <div class="overlay-icon blocked">üö´</div>
  <div class="overlay-title red">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
  <div class="info-card">
    <div class="label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô LINE</div>
    <div class="value" id="blocked-name">‚Äî</div>
  </div>
  <div class="alert-box red" id="blocked-reason">‚Äî</div>
  <div class="alert-box muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‡πÉ‡∏ô LINE Chat<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô<br>‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
  <button class="btn btn-secondary" style="max-width:200px" onclick="liff.closeWindow()">‚úï ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
</div>

<!-- Success -->
<div id="screen-success" class="overlay-screen hidden">
  <div class="overlay-icon success">‚úÖ</div>
  <div class="overlay-title green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
  <div class="success-id-box" id="success-tracking-display">‚Äî</div>
  <div class="alert-box green">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE Bot ‡πÅ‡∏•‡πâ‡∏ß<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó</div>
  <button class="btn btn-secondary" style="max-width:240px" onclick="resetAll()">üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
  <button class="btn btn-primary"   style="max-width:240px" onclick="liff.closeWindow()">‚úîÔ∏è ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏ä‡∏ó</button>
</div>

<!-- ============================================================ MAIN UI ============================================================ -->
<div class="header">
  <div class="header-icon">üì¶</div>
  <div>
    <div class="header-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏Ç‡πâ‡∏≤</div>
    <div class="header-sub">‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ ‡∏Å‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£ ‡∏õ.5</div>
  </div>
  <div class="admin-badge" id="admin-name-badge">...</div>
</div>

<div class="content">

  <div class="steps">
    <div class="step active" id="step1"><span class="step-num">1</span>‡∏™‡πÅ‡∏Å‡∏ô</div>
    <div class="step"        id="step2"><span class="step-num">2</span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    <div class="step"        id="step3"><span class="step-num">3</span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
  </div>

  <div class="status-bar info hidden" id="status-bar">
    <span id="status-icon">‚ÑπÔ∏è</span>
    <span id="status-text"></span>
  </div>

  <!-- ===== STEP 1: SCANNER ===== -->
  <div id="section-scanner">
    <div class="scanner-box">
      <div class="scanner-header">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏û‡∏±‡∏™‡∏î‡∏∏</div>

      <div id="camera-active" class="hidden">
        <div class="camera-wrap">
          <video id="camera-video" autoplay muted playsinline webkit-playsinline></video>
          <canvas id="scan-canvas" style="display:none"></canvas>
          <div class="scan-overlay">
            <div class="scan-frame">
              <div class="scan-frame-inner"></div>
              <div class="scan-line"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="camera-placeholder" class="camera-placeholder">
        <div class="camera-placeholder-icon">üì∑</div>
        <div>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô</div>
        <div class="text-muted">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CODE128 ¬∑ QR Code ¬∑ EAN ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
      </div>

      <div id="scan-result-display" class="result-display hidden">
        <div class="result-icon">‚úÖ</div>
        <div class="result-text">
          <div class="result-label">Tracking Number ‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ</div>
          <div class="result-value" id="scan-result-text">‚Äî</div>
        </div>
        <button class="result-clear" onclick="clearScanResult()">‚úï</button>
      </div>
    </div>

    <button class="btn btn-primary"   id="btn-start-scan"   onclick="startScanning()">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô</button>
    <div style="height:8px"></div>
    <button class="btn btn-secondary" id="btn-manual-entry" onclick="showManualEntry()">‚å®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏≠‡∏á</button>

    <div id="manual-entry-box" class="form-section hidden" style="margin-top:16px">
      <div class="form-header">‚å®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</div>
      <div class="form-body">
        <div class="field">
          <label>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ <span>*</span></label>
          <input type="text" id="manual-tracking" class="mono" placeholder="‡πÄ‡∏ä‡πà‡∏ô TH123456789TH"
                 autocomplete="off" autocapitalize="characters"
                 onkeydown="if(event.key==='Enter') confirmManualEntry()">
        </div>
        <button class="btn btn-primary"   onclick="confirmManualEntry()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ ‚ûú</button>
        <button class="btn btn-secondary" onclick="hideManualEntry()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>

    <button class="btn btn-primary mt-8 hidden" id="btn-to-step2" onclick="goToStep2()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚ûú</button>
  </div>

  <!-- ===== STEP 2: FORM ===== -->
  <div id="section-form" class="hidden">
    <div class="form-section">
      <div class="form-header">üì¶ ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô</div>
      <div style="padding:14px 16px">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:15px;font-weight:600;color:var(--green)" id="form-tracking-preview">‚Äî</div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-header">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏</div>
      <div class="form-body">
        <div class="field">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏¢‡∏® ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö <span>*</span></label>
          <input type="text" id="f-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à.‡∏™.‡∏≠. ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" oninput="checkFormFilled()">
        </div>
        <div class="field">
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span>*</span></label>
          <div class="field-row">
            <div class="field">
              <input type="tel" id="f-phone" placeholder="0801234567" maxlength="10" oninput="checkFormFilled()">
            </div>
            <button class="btn btn-secondary" style="width:auto;padding:11px 14px;white-space:nowrap;font-size:13px;flex-shrink:0" onclick="setNoPhone()">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå</button>
          </div>
          <div class="text-muted" id="phone-hint" style="margin-top:4px"></div>
        </div>
        <div class="field">
          <label>‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏û‡∏±‡∏™‡∏î‡∏∏ <span>*</span></label>
          <select id="f-type" onchange="checkFormFilled()">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏û‡∏±‡∏™‡∏î‡∏∏ --</option>
            <option value="‡∏Å‡∏•‡πà‡∏≠‡∏á">üì¶ ‡∏Å‡∏•‡πà‡∏≠‡∏á</option>
            <option value="‡∏ã‡∏≠‡∏á">üì® ‡∏ã‡∏≠‡∏á</option>
            <option value="‡∏ñ‡∏∏‡∏á">üõçÔ∏è ‡∏ñ‡∏∏‡∏á</option>
            <option value="‡∏°‡πâ‡∏ß‡∏ô">üßª ‡∏°‡πâ‡∏ß‡∏ô</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">üì¶ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary btn-back" onclick="goToStep1()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
      <button class="btn btn-primary" id="btn-to-step3" onclick="goToStep3()" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‚ûú</button>
    </div>
  </div>

  <!-- ===== STEP 3: CONFIRM ===== -->
  <div id="section-confirm" class="hidden">
    <div class="confirm-panel">
      <div class="confirm-header">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
      <div class="confirm-row"><div class="confirm-key">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</div> <div class="confirm-val mono" id="c-tracking">‚Äî</div></div>
      <div class="confirm-row"><div class="confirm-key">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</div><div class="confirm-val"      id="c-name">‚Äî</div></div>
      <div class="confirm-row"><div class="confirm-key">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div> <div class="confirm-val mono" id="c-phone">‚Äî</div></div>
      <div class="confirm-row"><div class="confirm-key">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞</div>   <div class="confirm-val"      id="c-type">‚Äî</div></div>
      <div class="confirm-row"><div class="confirm-key">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢</div><div class="confirm-val"      id="c-admin">‚Äî</div></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary btn-back" onclick="goToStep2()">‚Üê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <button class="btn btn-primary" id="btn-submit" onclick="submitPackage()">üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏</button>
    </div>
  </div>

</div><!-- end .content -->

<!-- ============================================================ JAVASCRIPT ============================================================ -->
<script>
// ============================================================
// ‚öôÔ∏è  CONFIG ‚Äî ‡πÅ‡∏Å‡πâ 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
// ============================================================
const LIFF_ID = '2009243376-Hd3IygRL';     // ‚ö†Ô∏è ‡πÉ‡∏™‡πà LIFF ID
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwy8AoWKvlT8JvV76UdiMAmCE41tZDn_TFK705CTXWiF5vV5UewKPAbdP7dFCiIZUP4JQ/exec'; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà Web App URL

// ============================================================
// STATE
// ============================================================
const state = {
  trackingNumber: '',
  adminName:      '',
  adminUserId:    '',
  adminType:      '',
  isScanning:     false,
  stream:         null,
  rafId:          null,    // requestAnimationFrame ID
  detector:       null     // BarcodeDetector instance (‡∏ñ‡πâ‡∏≤ browser ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
};

// ============================================================
// INIT
// ============================================================
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    const profile = await liff.getProfile();
    state.adminName   = profile.displayName;
    state.adminUserId = profile.userId;

    setLoadingText('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...');
    const auth = await checkAdminAuth(profile.userId);

    if (!auth.isAdmin) {
      document.getElementById('blocked-name').textContent   = profile.displayName;
      document.getElementById('blocked-reason').textContent = auth.reason || '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
      showScreen('blocked');
      return;
    }

    state.adminType = auth.adminType || 'STAFF';
    const adminLabel = state.adminType === 'MAIN_ADMIN' ? '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å' : '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
    const badge = document.getElementById('admin-name-badge');
    badge.textContent = profile.displayName;
    if (state.adminType === 'MAIN_ADMIN') badge.classList.add('main');
    document.getElementById('c-admin').textContent = `${profile.displayName} (${adminLabel})`;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ BarcodeDetector ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏° (Android Chrome / Samsung Browser)
    if (typeof BarcodeDetector !== 'undefined') {
      try {
        state.detector = new BarcodeDetector({
          formats: ['code_128','code_39','ean_13','ean_8','qr_code','data_matrix','itf','pdf417']
        });
      } catch(e) { state.detector = null; }
    }

    showScreen('main');
  } catch (err) {
    setLoadingText('‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
    setTimeout(() => { showScreen('main'); showStatus('error', err.message); }, 1000);
  }
}

async function checkAdminAuth(userId) {
  try {
    const resp = await fetch(`${GAS_URL}?action=check_admin&userId=${encodeURIComponent(userId)}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return await resp.json();
  } catch(e) {
    return { isAdmin: false, reason: `‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ\n(${e.message})\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà` };
  }
}

function showScreen(name) {
  ['loading','blocked','success'].forEach(s => document.getElementById(`screen-${s}`).classList.add('hidden'));
  if (name !== 'main') document.getElementById(`screen-${name}`).classList.remove('hidden');
}
function setLoadingText(t) { document.getElementById('loading-text').textContent = t; }

// ============================================================
// SCANNER ‚Äî ‡πÉ‡∏ä‡πâ native getUserMedia + BarcodeDetector / canvas loop
// ============================================================
async function startScanning() {
  try {
    document.getElementById('camera-placeholder').classList.add('hidden');
    document.getElementById('camera-active').classList.remove('hidden');
    const btn = document.getElementById('btn-start-scan');
    btn.textContent = '‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô';
    btn.onclick = stopScanning;
    document.getElementById('btn-manual-entry').classList.add('hidden');

    // ‡∏Ç‡∏≠ camera stream
    state.stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });

    const video = document.getElementById('camera-video');
    video.srcObject = state.stream;
    await new Promise(resolve => { video.onloadedmetadata = resolve; });
    await video.play();

    state.isScanning = true;

    if (state.detector) {
      // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: BarcodeDetector API (Android Chrome, Samsung)
      scanWithBarcodeDetector(video);
    } else {
      // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: canvas + ImageData loop (iOS LINE browser fallback)
      scanWithCanvasLoop(video);
    }

  } catch (err) {
    const msg = err.name === 'NotAllowedError'
      ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE'
      : err.message;
    showStatus('error', '‚ùå ' + msg);
    document.getElementById('camera-placeholder').classList.remove('hidden');
    document.getElementById('camera-active').classList.add('hidden');
    resetScanButtons();
  }
}

// --- ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: BarcodeDetector (Chrome/Android) ---
async function scanWithBarcodeDetector(video) {
  while (state.isScanning) {
    try {
      const codes = await state.detector.detect(video);
      if (codes.length > 0 && state.isScanning) {
        state.isScanning = false;
        handleScanResult(codes[0].rawValue);
        stopScanning();
        return;
      }
    } catch(e) { /* ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ */ }
    await new Promise(r => setTimeout(r, 120));
  }
}

// --- ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: canvas loop + inline barcode decode ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iOS ---
function scanWithCanvasLoop(video) {
  const canvas  = document.getElementById('scan-canvas');
  const ctx     = canvas.getContext('2d', { willReadFrequently: true });

  function tick() {
    if (!state.isScanning) return;

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width  = video.videoWidth  || 640;
      canvas.height = video.videoHeight || 480;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // ‡∏•‡∏≠‡∏á‡∏ó‡∏≥ crop ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ö‡∏Å‡∏•‡∏≤‡∏á (scan zone) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
      const zoneH = Math.floor(canvas.height * 0.35);
      const zoneY = Math.floor((canvas.height - zoneH) / 2);
      const imageData = ctx.getImageData(0, zoneY, canvas.width, zoneH);

      const result = decodeBarcode(imageData.data, canvas.width, zoneH);
      if (result && state.isScanning) {
        state.isScanning = false;
        handleScanResult(result);
        stopScanning();
        return;
      }
    }
    state.rafId = requestAnimationFrame(tick);
  }
  state.rafId = requestAnimationFrame(tick);
}

// --- Inline barcode decoder: CODE128 + simple QR fallback ---
// decode CODE128 ‡∏à‡∏≤‡∏Å pixel row ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
function decodeBarcode(data, width, height) {
  // ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢ row ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏û
  const rows = [
    Math.floor(height * 0.35),
    Math.floor(height * 0.50),
    Math.floor(height * 0.65),
  ];
  for (const row of rows) {
    const result = decodeCode128Row(data, width, height, row);
    if (result) return result;
  }
  return null;
}

function decodeCode128Row(data, width, height, row) {
  try {
    // ‡πÅ‡∏õ‡∏•‡∏á pixel row ‡πÄ‡∏õ‡πá‡∏ô binary string (threshold Otsu-like)
    const pixels = [];
    for (let x = 0; x < width; x++) {
      const idx = (row * width + x) * 4;
      const gray = (data[idx] * 77 + data[idx+1] * 150 + data[idx+2] * 29) >> 8;
      pixels.push(gray);
    }

    // adaptive threshold
    let sum = 0;
    for (let i = 0; i < pixels.length; i++) sum += pixels[i];
    const threshold = sum / pixels.length;

    // binary
    const bits = pixels.map(p => p < threshold ? 1 : 0);

    // ‡∏´‡∏≤ runs (‡∏™‡∏•‡∏±‡∏ö 0/1)
    const runs = [];
    let cur = bits[0], count = 1;
    for (let i = 1; i < bits.length; i++) {
      if (bits[i] === cur) { count++; }
      else { runs.push({ v: cur, n: count }); cur = bits[i]; count = 1; }
    }
    runs.push({ v: cur, n: count });

    // ‡∏´‡∏≤ start code 128 pattern (11211412) normalize by unit
    return tryCode128Decode(runs);
  } catch(e) { return null; }
}

function tryCode128Decode(runs) {
  // ‡∏´‡∏≤‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ quiet zone + start pattern
  // Code128 start: bars ratios 2-1-1-4-1-2 (‡∏´‡∏£‡∏∑‡∏≠ B/C variant)
  // ‡πÉ‡∏ä‡πâ heuristic: ‡∏´‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö bar ‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô barcode (‡∏™‡∏•‡∏±‡∏ö dark/light ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
  const barRuns = runs.filter((r,i) => i > 0 && i < runs.length-1);
  if (barRuns.length < 20) return null;

  // ‡∏´‡∏≤ unit width (bar ‡πÅ‡∏Ñ‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
  const darkRuns = runs.filter(r => r.v === 1);
  if (!darkRuns.length) return null;
  darkRuns.sort((a,b) => a.n - b.n);
  const unit = darkRuns[0].n;
  if (unit < 1) return null;

  // normalize
  const norm = runs.map(r => Math.max(1, Math.round(r.n / unit)));

  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Code128B start (11411211) ‡πÉ‡∏ô normalized runs
  // Start B = 2 1 1 4 1 2 (dark light dark light dark light)
  const startB = [2,1,1,4,1,2];
  const startC = [2,1,1,4,1,2]; // same bits, diff meaning
  const startA = [1,1,4,1,2,1,1]; 

  for (let i = 0; i < norm.length - 30; i++) {
    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ start pattern
    let matchB = true;
    for (let j = 0; j < startB.length; j++) {
      if (norm[i+j] !== startB[j]) { matchB = false; break; }
    }
    if (!matchB) continue;

    // ‡πÄ‡∏à‡∏≠ start ‚Äî decode characters
    return decodeCode128Chars(norm, i + startB.length, unit, runs);
  }
  return null;
}

function decodeCode128Chars(norm, startIdx, unit, originalRuns) {
  // Code128 B: each char = 3 bars + 3 spaces = 6 modules, total width 11 units
  // values map ‚Äî Code128B printable ASCII (space=0x20 ... ~=0x7E)
  const CODE128B = [
    ' ','!','"','#','$','%','&',"'",'(',')','*','+',',','-','.','/','0','1','2','3',
    '4','5','6','7','8','9',':',';','<','=','>','?','@','A','B','C','D','E','F','G',
    'H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','[',
    '\\',']','^','_','`','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o',
    'p','q','r','s','t','u','v','w','x','y','z','{','|','}','~'
  ];
  // All 103 Code128 symbol widths (6-bar patterns summing to 11)
  const PATTERNS = [
    [2,1,2,2,2,2],[2,2,2,1,2,2],[2,2,2,2,2,1],[1,2,1,2,2,3],[1,2,1,3,2,2],
    [1,3,1,2,2,2],[1,2,2,2,1,3],[1,2,2,3,1,2],[1,3,2,2,1,2],[2,2,1,2,1,3],
    [2,2,1,3,1,2],[2,3,1,2,1,2],[1,1,2,2,3,2],[1,2,2,1,3,2],[1,2,2,2,3,1],
    [1,1,3,2,2,2],[1,2,3,1,2,2],[1,2,3,2,2,1],[2,2,3,2,1,1],[2,2,1,1,3,2],
    [2,2,1,2,3,1],[2,1,3,2,1,2],[2,2,3,1,1,2],[3,1,2,1,3,1],[3,1,1,2,2,2],
    [3,2,1,1,2,2],[3,2,1,2,2,1],[3,1,2,2,1,2],[3,2,2,1,1,2],[3,2,2,2,1,1],
    [2,1,2,1,2,3],[2,1,2,3,2,1],[2,3,2,1,2,1],[1,1,1,3,2,3],[1,3,1,1,2,3],
    [1,3,1,3,2,1],[1,1,2,3,1,3],[1,3,2,1,1,3],[1,3,2,3,1,1],[2,1,1,3,1,3],
    [2,3,1,1,1,3],[2,3,1,3,1,1],[1,1,3,1,2,3],[1,1,3,3,2,1],[1,3,3,1,2,1],
    [1,1,2,1,3,3],[1,1,2,3,3,1],[1,3,2,1,3,1],[1,1,3,1,3,2],[1,3,1,3,1,2], // 50
    [1,3,1,1,3,2],[1,3,3,1,1,2],[2,3,1,1,3,1],[1,3,3,3,1,1],[1,1,1,1,3,4],
    [1,1,1,3,1,4],[1,3,1,1,1,4],[1,1,2,1,1,4],[1,1,4,1,1,2],[1,2,1,1,4,1],
    [1,4,1,1,1,2],[1,1,1,4,2,1],[1,2,1,4,1,1],[1,4,2,1,1,1],[4,1,1,1,2,1], // 64
    [1,1,1,2,4,1],[1,2,1,1,1,4],[1,4,1,2,1,1],[2,1,1,1,1,4],[2,1,1,4,1,1], // 69
    [1,4,1,1,2,1],[1,1,2,4,1,1],[2,4,1,1,1,1],[1,4,2,1,1,1],[1,1,3,4,1,1], // 74
    [4,3,1,1,1,1],[1,1,1,2,2,4],[1,1,1,4,2,2],[1,2,2,1,1,4],[1,4,2,2,1,1], // 79
    [4,1,2,1,1,2],[1,1,1,1,4,2],[1,2,1,1,2,4],[1,2,1,4,2,1],[2,1,2,1,1,4], // 84
    [2,1,4,1,1,2],[4,1,1,2,1,2],[1,3,1,2,2,1],[2,1,1,2,1,3],[3,3,1,1,1,2], // 89
    [1,1,2,1,4,2],[1,2,4,1,2,1],[1,3,4,1,1,1],[1,4,1,3,1,1],[2,4,1,2,1,1], // 94
    [4,1,1,1,1,3],[4,2,1,1,1,2],[1,2,3,1,1,2],[1,2,3,2,1,1],[1,2,1,3,3,1], // 99
    [1,1,3,1,1,3],[2,1,3,2,1,1],[2,3,3,1,1,1],[2,1,1,1,3,2]  // 103
  ];

  let result = '';
  let idx = startIdx;
  let maxChars = 40;

  while (idx + 6 <= norm.length && maxChars-- > 0) {
    const seg = norm.slice(idx, idx+6);
    let matched = -1;
    for (let p = 0; p < PATTERNS.length; p++) {
      if (PATTERNS[p].every((v,j) => v === seg[j])) { matched = p; break; }
    }
    if (matched === -1) break; // ‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡πâ‡∏≤ decode ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    if (matched === 106) break; // stop character
    if (matched < CODE128B.length) {
      result += CODE128B[matched];
    }
    idx += 6;
  }

  // ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÅ‡∏•‡∏∞ tracking pattern
  if (result.length >= 5) return result.trim();
  return null;
}

function stopScanning() {
  state.isScanning = false;
  if (state.rafId) { cancelAnimationFrame(state.rafId); state.rafId = null; }
  if (state.stream) {
    state.stream.getTracks().forEach(t => t.stop());
    state.stream = null;
  }
  const video = document.getElementById('camera-video');
  video.srcObject = null;
  document.getElementById('camera-active').classList.add('hidden');
  document.getElementById('camera-placeholder').classList.remove('hidden');
  resetScanButtons();
}

function resetScanButtons() {
  const btn = document.getElementById('btn-start-scan');
  btn.textContent = 'üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô';
  btn.onclick = startScanning;
  document.getElementById('btn-manual-entry').classList.remove('hidden');
}

function handleScanResult(code) {
  const clean = code.trim();
  if (!clean || clean.length < 5) return;
  state.trackingNumber = clean;
  document.getElementById('scan-result-text').textContent      = clean;
  document.getElementById('form-tracking-preview').textContent = clean;
  document.getElementById('scan-result-display').classList.remove('hidden');
  document.getElementById('btn-to-step2').classList.remove('hidden');
  showStatus('success', '‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
}

function clearScanResult() {
  state.trackingNumber = '';
  document.getElementById('scan-result-display').classList.add('hidden');
  document.getElementById('btn-to-step2').classList.add('hidden');
  clearStatus();
}

// ============================================================
// MANUAL ENTRY
// ============================================================
function showManualEntry() {
  document.getElementById('manual-entry-box').classList.remove('hidden');
  document.getElementById('btn-manual-entry').classList.add('hidden');
  setTimeout(() => document.getElementById('manual-tracking').focus(), 100);
}
function hideManualEntry() {
  document.getElementById('manual-entry-box').classList.add('hidden');
  document.getElementById('btn-manual-entry').classList.remove('hidden');
  document.getElementById('manual-tracking').value = '';
}
function confirmManualEntry() {
  const val = document.getElementById('manual-tracking').value.trim().toUpperCase();
  if (!val || val.length < 5) { showStatus('error','‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'); return; }
  hideManualEntry();
  handleScanResult(val);
}

// ============================================================
// FORM
// ============================================================
function checkFormFilled() {
  const name  = document.getElementById('f-name').value.trim();
  const phone = document.getElementById('f-phone').value.trim();
  const type  = document.getElementById('f-type').value;
  const phoneOk = /^0[689]\d{8}$/.test(phone.replace(/\D/g,'')) || phone === '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå';
  document.getElementById('btn-to-step3').disabled = !(name.length >= 2 && phoneOk && type !== '');
  const hint = document.getElementById('phone-hint');
  if (phone && phone !== '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå') {
    const c = phone.replace(/\D/g,'');
    if (/^0[689]\d{8}$/.test(c))    { hint.style.color='var(--green)';  hint.textContent='‚úì ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; }
    else if (c.length >= 4)          { hint.style.color='var(--yellow)'; hint.textContent='‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô 06/08/09 ‡πÅ‡∏•‡∏∞ 10 ‡∏´‡∏•‡∏±‡∏Å'; }
    else                              { hint.textContent=''; }
  } else { hint.textContent=''; }
}
function setNoPhone() { document.getElementById('f-phone').value='‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå'; checkFormFilled(); }

// ============================================================
// NAVIGATION
// ============================================================
function setStep(n) {
  [1,2,3].forEach(i => {
    const el = document.getElementById('step'+i);
    el.classList.remove('active','done');
    if (i < n) el.classList.add('done'); else if (i===n) el.classList.add('active');
  });
}
function goToStep1() {
  document.getElementById('section-form').classList.add('hidden');
  document.getElementById('section-confirm').classList.add('hidden');
  document.getElementById('section-scanner').classList.remove('hidden');
  setStep(1); clearStatus();
}
function goToStep2() {
  if (!state.trackingNumber) { showStatus('error','‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏ô'); return; }
  document.getElementById('section-scanner').classList.add('hidden');
  document.getElementById('section-confirm').classList.add('hidden');
  document.getElementById('section-form').classList.remove('hidden');
  setStep(2); clearStatus();
}
function goToStep3() {
  const name=document.getElementById('f-name').value.trim();
  const phone=document.getElementById('f-phone').value.trim();
  const type=document.getElementById('f-type').value;
  if (!name||!phone||!type) { showStatus('error','‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
  document.getElementById('c-tracking').textContent = state.trackingNumber;
  document.getElementById('c-name').textContent     = name;
  document.getElementById('c-phone').textContent    = phone;
  document.getElementById('c-type').textContent     = type;
  document.getElementById('section-form').classList.add('hidden');
  document.getElementById('section-confirm').classList.remove('hidden');
  setStep(3); clearStatus();
}

// ============================================================
// SUBMIT
// ============================================================
async function submitPackage() {
  const btn = document.getElementById('btn-submit');
  btn.disabled=true; btn.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  const tracking = state.trackingNumber;
  const name     = document.getElementById('f-name').value.trim();
  const phone    = document.getElementById('f-phone').value.trim();
  const type     = document.getElementById('f-type').value;
  const msg      = `${tracking}\n${name}\n${phone}\n${type}`;
  try {
    await liff.sendMessages([{ type:'text', text:msg }]);
    document.getElementById('success-tracking-display').textContent = tracking;
    showScreen('success');
  } catch(e) {
    try {
      const r = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ action:'liff_submit', userId:state.adminUserId, tracking, name, phone, type }) });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      document.getElementById('success-tracking-display').textContent = tracking;
      showScreen('success');
    } catch(e2) {
      showStatus('error','‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e2.message);
      btn.disabled=false; btn.textContent='üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏';
    }
  }
}

// ============================================================
// RESET & UTILS
// ============================================================
function resetAll() {
  state.trackingNumber='';
  ['f-name','f-phone','manual-tracking'].forEach(id => document.getElementById(id).value='');
  document.getElementById('f-type').value='';
  document.getElementById('btn-to-step3').disabled=true;
  document.getElementById('phone-hint').textContent='';
  document.getElementById('manual-entry-box').classList.add('hidden');
  document.getElementById('btn-manual-entry').classList.remove('hidden');
  clearScanResult();
  showScreen('main');
  goToStep1();
}
function showStatus(type, text) {
  const bar=document.getElementById('status-bar');
  bar.className=`status-bar ${type}`; bar.classList.remove('hidden');
  document.getElementById('status-icon').textContent={error:'‚ùå',success:'‚úÖ',info:'‚ÑπÔ∏è',warning:'‚ö†Ô∏è'}[type]||'‚ÑπÔ∏è';
  document.getElementById('status-text').textContent=text;
}
function clearStatus() { document.getElementById('status-bar').classList.add('hidden'); }

// START
init();
</script>
</body>
</html>
